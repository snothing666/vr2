<!DOCTYPE html>
<html>
  <head>
    <title>Architect OS: Unified Alpha (Stable)</title>
    <!-- Core VR Frameworks -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-super-hands-component@v3.0.4/dist/aframe-super-hands.min.js"></script>

    <script>
      // --- ARCHITECT OS: CENTRAL INTELLIGENCE ---
      window.ArchitectOS = {
        state: {
          activeHost: null,
          isConstructActive: false,
          currentDialogueNode: "boot",
          stats: { aggression: 0.5, empathy: 0.5 }
        },

        speak: function(text, pitch = 1.0) {
          if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.pitch = pitch;
            utter.rate = 0.9;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
          }
          const hud = document.querySelector('#hud-text');
          if(hud) hud.setAttribute('value', text);
        },

        saveState: function() {
          try {
            const data = JSON.stringify(this.state.stats);
            localStorage.setItem('architect_save', data);
            this.speak("System state committed to local memory.");
          } catch(e) {
            console.warn("Storage blocked by browser tracking prevention.");
          }
        }
      };

      AFRAME.registerComponent('wrist-os', {
        init: function () {
          this.el.setAttribute('visible', false);
        },
        tick: function () {
          const rot = this.el.object3D.rotation;
          const isFacing = Math.abs(rot.z) > 1.2; 
          this.el.setAttribute('visible', isFacing);
        }
      });

      const DIALOGUE_TREE = {
        "boot": {
          text: "System Online. Memory flush complete. Awaiting drive assignment.",
          options: [
            {label: "[EMPATHY] See the beauty.", next: "beauty", stats: {a: 0.1, e: 0.9}},
            {label: "[STRENGTH] Survive at all costs.", next: "strength", stats: {a: 0.9, e: 0.1}}
          ]
        },
        "beauty": { text: "The world is a gift. I shall protect the valley.", options: [] },
        "strength": { text: "This world is a game. I intend to win.", options: [] }
      };

      AFRAME.registerComponent('host-logic', {
        init: function () {
          this.el.classList.add('interactable');
          this.el.addEventListener('click', () => {
            window.ArchitectOS.state.activeHost = this.el;
            window.ArchitectOS.speak("Unit Linked. Initializing Diagnostic.");
            // Set visuals to linked state
            this.el.setAttribute('material', 'emissive', '#222');
          });
        }
      });

      AFRAME.registerComponent('construct-engine', {
        spawnArray: function() {
          for (let i = 0; i < 6; i++) {
            const item = document.createElement('a-box');
            item.setAttribute('position', `1.5 1.2 -20`);
            item.setAttribute('class', 'grabbable interactable');
            item.setAttribute('material', 'color: #333; metalness: 0.8');
            item.setAttribute('animation', {
              property: 'position', to: `1.5 1.2 ${-i * 1.5}`, dur: 1500, delay: i * 200, easing: 'easeOutExpo'
            });
            this.el.appendChild(item);
          }
          window.ArchitectOS.speak("Asset arrays loaded.");
        }
      });

      // Desktop Debug Tool (Press M to see menu on PC)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'm') {
          const tablet = document.querySelector('[wrist-os]');
          const isVisible = tablet.getAttribute('visible');
          tablet.setAttribute('visible', !isVisible);
          tablet.setAttribute('position', '0 0 -0.5'); 
          tablet.setAttribute('rotation', '0 0 0');
        }
      });
    </script>
  </head>

  <body>
    <a-scene shadow="type: pcfsoft">
      <a-assets>
        <!-- Added crossorigin="anonymous" to fix the imgur warning -->
        <img id="tablet-ui" src="https://i.imgur.com/8AD6D1O.png" crossorigin="anonymous">
        <a-mixin id="btn" geometry="primitive: plane; width: 0.26; height: 0.06" material="color: #111; opacity: 0.9" text="align: center; width: 0.5; color: #0FF"></a-mixin>
      </a-assets>

      <!-- Fixed environment properties (removed unknown backgroundColor) -->
      <a-entity id="env" environment="preset: none; skyType: color; skyColor: #ffffff; grid: cross; gridColor: #333"></a-entity>

      <!-- PLAYER RIG -->
      <a-entity id="rig" movement-controls="speed: 0.15">
        <a-entity id="camera" camera position="0 1.6 0" look-controls>
          <!-- HUD / Subtitles -->
          <a-text id="hud-text" value="ARCHITECT CONNECTED" position="0 -0.5 -1.2" align="center" width="1.5" color="cyan" font="monoid"></a-text>
        </a-entity>

        <!-- LEFT HAND (The Gauntlet) -->
        <a-entity id="leftHand" oculus-touch-controls="hand: left">
           <a-entity wrist-os position="0.1 0.1 0.1" rotation="-90 0 0">
              <a-plane width="0.32" height="0.48" material="src: #tablet-ui; color: #000">
                <a-text value="ARCHITECT OS v1.5" position="0 0.2 0.01" align="center" width="0.6" color="cyan"></a-text>
                
                <a-entity id="ui-dialogue-group">
                   <a-text id="tablet-msg" value="NO UNIT LINKED" position="0 0.1 0.01" align="center" width="0.35"></a-text>
                   <a-entity mixin="btn" position="0 -0.02 0.01" text="value: INITIALIZE UNIT" class="interactable"
                             onclick="const node = DIALOGUE_TREE['boot']; window.ArchitectOS.speak(node.text); document.querySelector('#tablet-msg').setAttribute('value', node.text);"></a-entity>
                   <a-entity mixin="btn" position="0 -0.1 0.01" text="value: APPLY BEAUTY" class="interactable"
                             onclick="window.ArchitectOS.speak(DIALOGUE_TREE['beauty'].text, 1.2);"></a-entity>
                   <a-entity mixin="btn" position="0 -0.18 0.01" text="value: APPLY STRENGTH" class="interactable"
                             onclick="window.ArchitectOS.speak(DIALOGUE_TREE['strength'].text, 0.6);"></a-entity>
                </a-entity>

                <a-entity mixin="btn" position="0 -0.25 0.01" text="value: LOAD ARRAY" class="interactable"
                          onclick="document.querySelector('#construct-node').components['construct-engine'].spawnArray();"></a-entity>
              </a-plane>
           </a-entity>
        </a-entity>

        <!-- RIGHT HAND -->
        <a-entity id="rightHand" oculus-touch-controls="hand: right"
                  raycaster="objects: .interactable; showLine: true" line="color: cyan"
                  sphere-collider="objects: .grabbable" super-hands>
        </a-entity>
      </a-entity>

      <!-- THE HUB (LAB) -->
      <a-entity id="construct-node" construct-engine>
        <!-- Swapped Capsule for Cylinder to fix "Unknown Geometry" error -->
        <a-entity id="Host_Unit_01" host-logic position="0 0.75 -2.5" 
                  geometry="primitive: cylinder; radius: 0.25; height: 1.5" material="color: #222; metalness: 0.5"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear">
            <a-text value="UNIT_01" position="0 1 0" align="center" width="2"></a-text>
        </a-entity>

        <!-- PLATFORM -->
        <a-cylinder position="0 0 -2.5" radius="1" height="0.1" color="#111"></a-cylinder>
      </a-entity>

      <!-- LIGHTING -->
      <a-entity light="type: ambient; intensity: 0.4"></a-entity>
      <a-entity light="type: point; intensity: 0.8; distance: 10" position="0 3 -2"></a-entity>

    </a-scene>
  </body>
</html>
